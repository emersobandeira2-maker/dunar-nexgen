// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Modelo de Usuários (Clientes)
model User {
  id               String        @id @default(uuid())
  name             String
  email            String        @unique
  phone            String?
  documentType     String?       // "CPF" ou "CNPJ"
  document         String?       // CPF ou CNPJ
  passwordHash     String
  resetToken       String?       // Token para recuperação de senha
  resetTokenExpiry DateTime?     // Validade do token
  lifetimePrize    Boolean       @default(false) // Prêmio Vitalício (6 placas grátis/dia)
  vehicles         Vehicle[]
  reservations     Reservation[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

// Modelo de Administradores
model Admin {
  id               String    @id @default(uuid())
  username         String    @unique
  email            String    @unique
  phone            String?
  passwordHash     String
  role             String    @default("FUNCIONARIO") // "SUPERADMIN", "ADMIN", "FUNCIONARIO"
  isSuperAdmin     Boolean   @default(false) // Flag para proteger superadmin
  twoFactorEnabled Boolean   @default(false)
  twoFactorMethod  String?   // "email" ou "sms"
  twoFactorCode    String?
  twoFactorExpiry  DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

// Modelo de Configurações do Sistema
model SystemConfig {
  id                String   @id @default(uuid())
  normalAccessPrice Float    @default(50.00) // Preço padrão do acesso avulso
  coopAccessPrice   Float    @default(40.00) // Preço padrão do cooperado
  updatedBy         String?  // ID do admin que fez a última alteração
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Modelo de Cooperados
model Cooperative {
  id        String    @id @default(uuid())
  name      String    // Nome do cooperado ou cooperativa
  vehicleId String    @unique
  vehicle   Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  price     Float     @default(40.00) // Preço personalizado (padrão R$ 40)
  isActive  Boolean   @default(true)
  createdBy String?   // ID do admin que cadastrou
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// Modelo de Eventos
model Event {
  id          String    @id @default(uuid())
  name        String    // Nome do evento
  vehicleId   String    @unique
  vehicle     Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  price       Float     // Preço personalizado definido pelo admin
  eventDate   DateTime? // Data do evento (opcional)
  description String?   @db.Text // Descrição do evento
  isActive    Boolean   @default(true)
  createdBy   String?   // ID do admin que cadastrou
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Modelo de Placas/Veículos
model Vehicle {
  id           String        @id @default(uuid())
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  plate        String        @unique
  plateRole    String        // 'Comum', 'Cooperado', 'Evento', 'Proprietario'
  reservations Reservation[]
  tickets      Ticket[]
  cooperative  Cooperative?  // Relação opcional com cooperado
  event        Event?        // Relação opcional com evento
  createdAt    DateTime      @default(now())
}

// Modelo de Reservas
model Reservation {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicleId  String
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  passengers Int
  startDate  DateTime
  endDate    DateTime
  status     String   @default("pending") // 'pending', 'confirmed', 'cancelled'
  tickets    Ticket[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// Modelo de Tickets (Pagamentos/Entradas)
model Ticket {
  id              String       @id @default(uuid())
  reservationId   String?
  reservation     Reservation? @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  vehicleId       String
  vehicle         Vehicle      @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  passengers      Int
  useDate         DateTime
  paymentStatus   String       @default("Pendente") // 'Pendente', 'Pago'
  ticketStatus    String       @default("Aguardando Liberação") // 'Aguardando Liberação', 'Liberado', 'Expirado'
  paymentMethod   String?
  paymentId       String?
  price           Float?       // Valor do ticket
  ticketType      String       @default("Normal") // 'Normal', 'Cooperado', 'Evento'
  isFree          Boolean      @default(false) // Indica se foi grátis (prêmio vitalício)
  releasedBy      String?      // ID do admin/funcionário que liberou
  releasedAt      DateTime?    // Data/hora da liberação
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([paymentStatus])
  @@index([ticketStatus])
  @@index([useDate])
  @@index([createdAt])
  @@index([vehicleId])
  @@index([ticketType])
}
